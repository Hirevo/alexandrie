<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Docker - Alexandrie</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../installation-script.html"><strong aria-hidden="true">3.</strong> Installation script</a></li><li class="chapter-item expanded "><a href="../concepts/mod.html"><strong aria-hidden="true">4.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/crate-index.html"><strong aria-hidden="true">4.1.</strong> Crate index</a></li><li class="chapter-item expanded "><a href="../concepts/crate-storage.html"><strong aria-hidden="true">4.2.</strong> Crate storage</a></li></ol></li><li class="chapter-item expanded "><a href="../whats-available/mod.html"><strong aria-hidden="true">5.</strong> What's available ?</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../whats-available/index-management-strategies.html"><strong aria-hidden="true">5.1.</strong> Index management strategies</a></li><li class="chapter-item expanded "><a href="../whats-available/crate-stores.html"><strong aria-hidden="true">5.2.</strong> Crate stores</a></li><li class="chapter-item expanded "><a href="../whats-available/docker.html" class="active"><strong aria-hidden="true">5.3.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../whats-available/authentication-strategies.html"><strong aria-hidden="true">5.4.</strong> Authentication Strategies</a></li></ol></li><li class="chapter-item expanded "><a href="../programmatic-api/mod.html"><strong aria-hidden="true">6.</strong> Programmatic API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../programmatic-api/authentication.html"><strong aria-hidden="true">6.1.</strong> Authentication</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/mod.html"><strong aria-hidden="true">6.2.</strong> Account Management section</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../programmatic-api/account/login/post.html"><strong aria-hidden="true">6.2.1.</strong> Account Login</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/register/post.html"><strong aria-hidden="true">6.2.2.</strong> Account Registration</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/tokens/get.html"><strong aria-hidden="true">6.2.3.</strong> Token Information (from name)</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/tokens/post.html"><strong aria-hidden="true">6.2.4.</strong> Token Information (from token)</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/tokens/put.html"><strong aria-hidden="true">6.2.5.</strong> Token Generation</a></li><li class="chapter-item expanded "><a href="../programmatic-api/account/tokens/delete.html"><strong aria-hidden="true">6.2.6.</strong> Token Revocation</a></li></ol></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/mod.html"><strong aria-hidden="true">6.3.</strong> Crates section</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../programmatic-api/crates/search/get.html"><strong aria-hidden="true">6.3.1.</strong> Crate Search</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/info/get.html"><strong aria-hidden="true">6.3.2.</strong> Crate Information</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/owners/get.html"><strong aria-hidden="true">6.3.3.</strong> Crate Owner Listing</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/owners/put.html"><strong aria-hidden="true">6.3.4.</strong> Crate Owner Addition</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/owners/delete.html"><strong aria-hidden="true">6.3.5.</strong> Crate Owner Removal</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/download/get.html"><strong aria-hidden="true">6.3.6.</strong> Crate Archive Download</a></li><li class="chapter-item expanded "><a href="../programmatic-api/categories/get.html"><strong aria-hidden="true">6.3.7.</strong> Crate Categories Listing</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/publish/put.html"><strong aria-hidden="true">6.3.8.</strong> Crate Publication</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/yank/delete.html"><strong aria-hidden="true">6.3.9.</strong> Crate Version Yanking</a></li><li class="chapter-item expanded "><a href="../programmatic-api/crates/unyank/put.html"><strong aria-hidden="true">6.3.10.</strong> Crate Version Unyanking</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../database-layout.html"><strong aria-hidden="true">7.</strong> Database layout</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Alexandrie</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#running-alexandrie-with-docker" id="running-alexandrie-with-docker">Running Alexandrie with Docker</a></h1>
<p>Alexandrie can be run in a Docker container, which can make it easier to start, stop, and build on a non-Linux system.</p>
<h2><a class="header" href="#dependencies" id="dependencies">Dependencies</a></h2>
<p>To run Alexandrie in docker, you'll need:</p>
<ul>
<li>The <code>Alexandrie</code> source code pulled from GitHub</li>
<li><a href="https://docs.docker.com/install/">docker</a></li>
<li><a href="https://docs.docker.com/compose/install/">docker-compose</a></li>
</ul>
<p>Make sure that <code>docker</code> and <code>docker-compose</code> are in your system path.</p>
<h2><a class="header" href="#user-configuration" id="user-configuration">User Configuration</a></h2>
<p>A small bit of setup is required before you can start the docker containers. First, copy <code>example.env</code> to <code>.env</code> (the filename is important, don't prefix the extension), and modify the values inside:</p>
<ul>
<li>Create a new, empty directory where the application can create data, and then set <code>APPDATA</code> to the absolute path to that folder.</li>
<li>Set <code>CRATE_INDEX</code> to the SSH path of an existing git repository with a valid index <code>config.json</code> file.</li>
<li>Set <code>GIT_NAME</code> and <code>GIT_EMAIL</code> to valid git values that will be used when Alexandrie commits &amp; pushes those commits to the index.</li>
<li>Set <code>GIT_SSH_KEY</code> to a new or existing passwordless SSH key. The <code>.pub</code> key associated with this key should be added to github/gitlab/etc. to grant access to clone and push the crate index.</li>
</ul>
<p>By default Alexandrie will use SQLite. If you want to use either MySQL or PostgreSQL instead, you'll need to create a file at either <code>docker/mysql/rootpass.txt</code> or <code>docker/postgres/rootpass.txt</code> which contains the password that will be given to the root user of the database.</p>
<h3><a class="header" href="#additional-configuration" id="additional-configuration">Additional Configuration</a></h3>
<p>If necessary, <code>alexandrie.toml</code> and even <code>diesel.toml</code> can still be modified, and the docker images can be configured to use those modified files instead. You should read the <a href="#internals">Internals</a> section first, and will likely need to already have docker knowledge. Some other config files and scripts will need to be modified if you change Alexandrie's port or appdata mount location, for example.</p>
<p>You can also define the environment variables <code>USER_ID</code> and <code>GROUP_ID</code> to specify the UID and GID of the <code>alex</code> user created in the web container.</p>
<h2><a class="header" href="#usage" id="usage">Usage</a></h2>
<h3><a class="header" href="#running" id="running">Running</a></h3>
<p>To run, you can use the <code>run_docker.sh</code> script for easy setup or teardown. See <code>run_docker.sh --help</code> for a list of options.</p>
<p>By default, Alexandrie will use SQLite and run in the background.</p>
<p><strong>Bringup:</strong></p>
<pre><code class="language-bash">./run_docker.sh up
</code></pre>
<p>If you want to use MySQL and run in the foreground, here's an example:</p>
<pre><code class="language-bash">./run_docker.sh up --mysql -f
</code></pre>
<p>If you run in the foreground and kill the services with <code>Ctrl+C</code>, the docker containers will stop, but you still may need to run <a href="#stopping-and-cleanup">teardown</a> for the containers to be deleted fully.</p>
<h3><a class="header" href="#stopping-and-cleanup" id="stopping-and-cleanup">Stopping and Cleanup</a></h3>
<p>Stopping Alexandrie is as easy as starting it.</p>
<p><strong>Teardown:</strong></p>
<pre><code class="language-bash">./run_docker.sh down
</code></pre>
<p>To stop, for example, a MySQL setup for Alexandrie, run the following:</p>
<pre><code class="language-bash">./run_docker.sh down --mysql
</code></pre>
<p>If you're not planning on running Alexandrie again or want to do a full clean of the environment, you can disassociate your local appdata storage from the docker volume database by doing <code>docker volume prune</code>, which will delete all unused volumes.</p>
<h3><a class="header" href="#next-steps" id="next-steps">Next Steps</a></h3>
<p>As Alexandrie will (by default) serve on port <code>3000</code> (and directly setting that to port <code>80</code> will likely not work for a non-root user and won't allow https), the recommended way to serve the application would be to install &amp; configure <code>nginx</code> or another ingress controller.</p>
<h2><a class="header" href="#internals" id="internals">Internals</a></h2>
<p>The <code>run_docker</code> script is using <code>docker-compose</code> under the hood, which is itself just <code>docker</code> instrumentation. <code>docker-compose</code> is configured for this project through a few files:</p>
<ul>
<li><code>.env</code>: contains variables that can be changed by the user for easy configuration</li>
<li><code>docker-compose.yaml</code>: basic setup for docker images, volumes, etc.; should rarely be touched by the user</li>
<li><code>docker/&lt;database&gt;/&lt;database&gt;-compose.yaml</code>: supplemental and database-dependent; should rarely be touched by the user</li>
</ul>
<p>Some additional files are responsible for actually creating the Docker image for Alexandrie, as well as handling starting the application, database, etc.:</p>
<ul>
<li><code>Dockerfile</code>: definition for creating the Docker image for Alexandrie itself</li>
<li><code>docker/startup.sh</code>: ran inside the Docker image to do first-run database initialization with diesel, ssh &amp; git configuration, and start Alexandrie</li>
<li><code>docker/&lt;database&gt;/alexandrie.toml</code>: application configuration, which has database-dependent features</li>
</ul>
<p>Modifying <code>alexandrie.toml</code> may require additional modification of some of these files, for example if the port is modified.</p>
<p>It's worth mentioning that the Docker image will copy the Alexandrie source contained in the local directory, a.k.a. the source isn't pulled down from the git repo when building the image. If you modifiy the source code, those modifications can be used to make the image for testing, etc.</p>
<h3><a class="header" href="#example-run" id="example-run">Example Run</a></h3>
<p>To start Alexandrie in Docker without the <code>run_docker</code> script, you could do:</p>
<pre><code class="language-bash">export DATABASE=mysql
docker-compose -f docker-compose.yaml -f docker/mysql/mysql-compose.yaml up
</code></pre>
<p>This will use all of the following files, in addition to the Alexandrie source code:</p>
<ul>
<li><code>docker-compose.yaml</code></li>
<li><code>.env</code></li>
<li><code>diesel.toml</code></li>
<li><code>Dockerfile</code></li>
<li><code>docker/startup.sh</code></li>
<li><code>docker/mysql/mysql-compose.yaml</code></li>
<li><code>docker/mysql/alexandrie.toml</code></li>
<li><code>docker/mysql/rootpass.txt</code></li>
</ul>
<h3><a class="header" href="#database" id="database">Database</a></h3>
<p>Databases will put their data in an appropriately named directory inside the user-defined <code>APPDATA</code> directory (see <a href="#user-configuration">User Configuration</a>). If the directory already exists, it must either <strong>(a)</strong> have valid database data inside, or <strong>(b)</strong> be empty. Directly modifying files inside the database directory isn't recommended, and can cause the server to fail to start entirely. Don't add extra files or create a file inside an empty database directory; the database will almost certainly complain.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../whats-available/crate-stores.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../whats-available/authentication-strategies.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../whats-available/crate-stores.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../whats-available/authentication-strategies.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
